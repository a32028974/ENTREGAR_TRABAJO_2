function doGet(e){
  const a = (e.parameter.action||'').trim();
  if (a==='lookup')  return json( lookupTrabajo(e.parameter.numero) );
  if (a==='pagos')   return json( listPagos(e.parameter.numero) );
  if (a==='addPago') return json( addPago(e.parameter) );
  if (a==='entregar')return json( marcarEntregado(e.parameter.numero, e.parameter.entregadoPor) );
  return json({ok:false, error:'action inválida'});
}

function json(o){ return ContentService.createTextOutput(JSON.stringify(o)).setMimeType(ContentService.MimeType.JSON); }

function lookupTrabajo(numero){
  // TODO: buscar en hoja "Trabajos" por número (columna que uses)
  // devolver objeto con totales y lo que ya pagó (si tenés una col. acumulada)
  // ejemplo de respuesta:
  // { ok:true, numero:'123', paciente:'Juan', total: 50000, senia: 10000, pagado: 15000, ... }
}

function listPagos(numero){
  const sh = SpreadsheetApp.getActive().getSheetByName('Pagos');
  const rows = sh.getDataRange().getValues(); // o un filtro más eficiente
  const items = [];
  for (let i=1;i<rows.length;i++){
    const [fh, num, importe, fdm, fdmOtro, vendedor] = rows[i];
    if (String(num)==String(numero)){
      items.push({ fecha: Utilities.formatDate(new Date(fh), Session.getScriptTimeZone(), "dd/MM/yyyy HH:mm"), importe, fdm, fdmOtro, vendedor });
    }
  }
  return {ok:true, items};
}

function addPago(p){
  const numero   = p.numero;
  const importe  = Number(p.importe||0);
  const fdm      = p.fdm||'';
  const fdmOtro  = p.fdmOtro||'';
  const vendedor = p.vendedor||'';

  const sh = SpreadsheetApp.getActive().getSheetByName('Pagos');
  sh.appendRow([new Date(), numero, importe, fdm, fdmOtro, vendedor]);

  // recomputar totalPagos y saldo
  const pagos = listPagos(numero).items.reduce((acc,it)=> acc + Number(it.importe||0), 0);
  const t = lookupTrabajo(numero); // debe traer total y seña
  const total = Number(t.total||0), senia = Number(t.senia||t.seña||0);
  const saldo = Math.max(0, total - senia - pagos);

  // si querés, también podés escribir totalPagos en la hoja Trabajos
  // ...

  return { ok:true, totalPagos: pagos, saldo };
}

function marcarEntregado(numero, entregadoPor){
  // Chequear saldo
  const pagos = listPagos(numero).items.reduce((acc,it)=> acc + Number(it.importe||0), 0);
  const t = lookupTrabajo(numero);
  const total = Number(t.total||0), senia=Number(t.senia||t.seña||0);
  const saldo = Math.max(0, total - senia - pagos);
  if (saldo>0) return {ok:false, error:'Saldo pendiente'};

  // Escribir marca de entrega en hoja "Trabajos" (fecha + quien)
  // ...
  const fh = new Date();
  return { ok:true, fecha: Utilities.formatDate(fh, Session.getScriptTimeZone(), "dd/MM/yyyy HH:mm") };
}

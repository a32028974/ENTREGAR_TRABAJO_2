<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Entrega ‚Ä¢ √ìptica Cristal</title>
<link rel="icon" href="logo.png" />
<style>
  :root { --bg:#0b1220; --card:#121a2b; --text:#e8eefc; --muted:#9fb0d6; --accent:#7cc0ff; }
  *{box-sizing:border-box}
  body{margin:0; font:16px/1.4 system-ui,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text);}
  .wrap{max-width:640px;margin:24px auto;padding:16px}
  .card{background:var(--card);border:1px solid #1e2a42;border-radius:14px;padding:16px;box-shadow:0 6px 22px rgba(0,0,0,.25)}
  h1{margin:0 0 12px 0;font-size:20px}
  label{display:block;font-size:13px;color:var(--muted);margin:12px 0 6px}
  input,select,button{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #2a3b5f;background:#0e1626;color:var(--text)}
  input::placeholder{color:#6e82ad}
  button{background:var(--accent); color:#05223a; font-weight:700; border:none; cursor:pointer}
  button:disabled{opacity:.6;cursor:not-allowed}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .ok{color:#8fffb3;margin-top:8px}
  .err{color:#ff9c9c;margin-top:8px}
  .muted{color:var(--muted)}
  .hidden{display:none}
  .pill{display:inline-block;background:#0f223a;border:1px solid #294a78;color:#b8d5ff;border-radius:999px;padding:6px 10px;margin-top:6px}
  .hr{height:1px;background:#203152;margin:14px 0}

  .table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 14px;
           background:#0e1626; border:1px solid #2a3b5f; border-radius: 10px; overflow: hidden; }
  .table th, .table td { padding: 8px 10px; border-bottom: 1px solid #22324f; text-align: left; white-space: nowrap; }
  .table tr:last-child td { border-bottom: 0; }
  .table th { color:#b8d5ff; font-weight:600; background:#0f1a2c; }
  .table tr { cursor: pointer; }
  .table tr:hover { background:#0f223a; }
  .table .num { font-weight:700; color:#9fd1ff; }

  .spinner { display:inline-block; width:14px; height:14px; border:2px solid #6e82ad; border-top-color:transparent; border-radius:50%; vertical-align:-2px; animation:spin 1s linear infinite; margin-right:6px; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .input-row { display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:end; }
  .scanBtn { padding:12px 14px; border-radius:10px; border:1px solid #2a3b5f; background:#113052; color:#b8d5ff; font-weight:700; }
  .scanBtn:hover { background:#14365d; }

  .scan-modal { position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; place-items:center; padding:16px; z-index:9999; }
  .scan-modal.open { display:grid; }
  .scan-box { width:min(520px,96vw); background:var(--card); border:1px solid #1e2a42; border-radius:14px; padding:12px; box-shadow: 0 12px 32px rgba(0,0,0,.45); }
  .scan-head { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px; }
  .scan-close { padding:10px 12px; border-radius:10px; border:1px solid #2a3b5f; background:#0e1626; color:var(--text); cursor:pointer; }
  .scan-video { width:100%; border-radius:12px; border:1px solid #22324f; background:#000; display:block; }
  .scan-hint { margin-top:8px; font-size:12px; color:#9fb0d6; }

  .moneyCard{background:#0f1a2c;border:1px solid #22324f;border-radius:12px;padding:10px;margin-top:10px}
  .moneyRow{display:flex;justify-content:space-between;gap:10px;margin:4px 0}
  .moneyRow .lbl{color:#b8d5ff}
  .moneyRow .val{font-weight:700}
  .totalRow{border-top:1px dashed #22324f;margin-top:6px;padding-top:6px}
  .saldo{color:#8fffb3}
  .neg{color:#ffcc99}

  .payGrid{display:grid;grid-template-columns:1fr 1fr auto;gap:10px}
  .btnSecondary{background:#0e1626;border:1px solid #2a3b5f;color:#e8eefc}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Registrar entrega / pago de saldo</h1>

      <label for="numero">N√∫mero de trabajo</label>
      <div class="input-row">
        <input id="numero" type="text" inputmode="numeric" placeholder="Escrib√≠ el n√∫mero y presion√° Enter" autocomplete="off" />
        <button id="btnScan" class="scanBtn" type="button">üì∑ Escanear</button>
      </div>
      <div id="status" class="muted" aria-live="polite"></div>

      <!-- Coincidencias -->
      <div id="listaWrap" class="hidden">
        <div class="hr"></div>
        <div class="muted">Coincidencias encontradas (eleg√≠ una)</div>
        <div style="overflow:auto; max-height:260px; border-radius:10px; margin-top:6px;">
          <table class="table" id="lista"></table>
        </div>
      </div>

      <div id="resultado" class="hidden">
        <div class="hr"></div>
        <div class="muted">Paciente</div>
        <div id="paciente" class="pill"></div>

        <div id="entregaInfo" class="muted" style="margin-top:8px;"></div>

        <!-- Montos -->
        <div class="moneyCard" id="montosBox">
          <div class="moneyRow"><span class="lbl">Armaz√≥n</span><span class="val" id="m-armazon">$0,00</span></div>
          <div class="moneyRow"><span class="lbl">Cristal</span><span class="val" id="m-cristal">$0,00</span></div>
          <div class="moneyRow"><span class="lbl">Otro concepto</span><span class="val" id="m-otros">$0,00</span></div>
          <div class="moneyRow"><span class="lbl">Obra social</span><span class="val neg" id="m-obra">$0,00</span></div>
          <div class="moneyRow totalRow"><span class="lbl">Total</span><span class="val" id="m-total">$0,00</span></div>
          <div class="moneyRow"><span class="lbl">Se√±a</span><span class="val" id="m-senia">$0,00</span></div>
          <div class="moneyRow"><span class="lbl">Pagos previos</span><span class="val" id="m-pagos">$0,00</span></div>
          <div class="moneyRow"><span class="lbl saldo">Saldo</span><span class="val saldo" id="m-saldo">$0,00</span></div>
        </div>

        <!-- Registrar pago -->
        <div class="hr"></div>
        <div class="row3">
          <div>
            <label for="entregadoPor">Vendedor/a</label>
            <input id="entregadoPor" type="text" placeholder="Nombre del vendedor/a" autocomplete="off" />
          </div>
          <div>
            <label for="cancelo">Importe a cobrar (sugerido: saldo)</label>
            <input id="cancelo" type="number" step="0.01" placeholder="0.00" inputmode="decimal" />
          </div>
          <div>
            <label for="fdm">Medio</label>
            <select id="fdm">
              <option value="">Eleg√≠‚Ä¶</option>
              <option>EFECTIVO</option>
              <option>TARJETA 1P</option>
              <option>TARJETA 3P</option>
              <option>TARJETA 6P</option>
              <option>TARJETA 12P</option>
              <option>TRANSFERENCIA</option>
              <option>MERCADO PAGO</option>
              <option>OTRO</option>
            </select>
          </div>
        </div>
        <div id="wrapFdmOtro" class="hidden">
          <label for="fdmOtro">Si eleg√≠s OTRO, especific√°</label>
          <input id="fdmOtro" type="text" placeholder="Ej: CHEQUE, VALE, PROMO X, etc." autocomplete="off" />
        </div>

        <div class="row" style="margin-top:10px">
          <button id="btnAgregarPago">Registrar pago</button>
          <button id="btnEntregar" class="btnSecondary" disabled>Marcar como ENTREGADO</button>
        </div>
        <div id="saveMsg" class="ok hidden">‚úî Guardado</div>
        <div id="saveErr" class="err hidden"></div>

        <!-- Historial de pagos -->
        <div class="hr"></div>
        <div class="muted">Historial de pagos</div>
        <div style="overflow:auto; max-height:260px; border-radius:10px; margin-top:6px;">
          <table class="table" id="tablaPagos">
            <thead><tr><th>Fecha</th><th>Medio</th><th>Importe</th><th>Vendedor/a</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal escaneo -->
  <div id="scanModal" class="scan-modal">
    <div id="scanBox" class="scan-box">
      <div class="scan-head">
        <h3>Escanear c√≥digo de barras</h3>
        <button id="scanClose" class="scan-close" type="button">Cerrar</button>
      </div>
      <video id="scanVideo" class="scan-video" playsinline muted></video>
      <div id="scanHint" class="scan-hint">Apunt√° al c√≥digo hasta que se detecte autom√°ticamente.</div>
    </div>
  </div>

<script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyAt5RiyFRlWQJ5uMTVlc8GAX-ssAbjmYY_nVgMAQJi97t5g_spE6kapKt2yCQUnWCcnA/exec';

  // ===== DOM =====
  const $ = (id)=>document.getElementById(id);
  const numeroInput = $('numero'), status=$('status'), listaWrap=$('listaWrap'), listaTable=$('lista'),
        resultado=$('resultado'), paciente=$('paciente'), entregaInfo=$('entregaInfo');
  const entregadoPor=$('entregadoPor'), cancelo=$('cancelo'), fdm=$('fdm'), fdmOtroWrap=$('wrapFdmOtro'), fdmOtro=$('fdmOtro');
  const btnAgregarPago=$('btnAgregarPago'), btnEntregar=$('btnEntregar'), saveMsg=$('saveMsg'), saveErr=$('saveErr');
  const mArmazon=$('m-armazon'), mCristal=$('m-cristal'), mOtros=$('m-otros'), mObra=$('m-obra'), mTotal=$('m-total'),
        mSenia=$('m-senia'), mPagos=$('m-pagos'), mSaldo=$('m-saldo');
  const tablaPagos=$('tablaPagos').querySelector('tbody');

  // Esc√°ner
  const btnScan=$('btnScan'), scanModal=$('scanModal'), scanVideo=$('scanVideo'), scanClose=$('scanClose'), scanHint=$('scanHint');

  // ===== Cach√© =====
  const LS_CACHE='oc_entrega_cache_v2', LS_MRU='oc_entrega_mru_v1', CACHE_TTL_MS=15*60*1000;
  const now=()=>Date.now();
  const readJSON=(k,fb)=>{ try{const s=localStorage.getItem(k); return s?JSON.parse(s):fb;}catch{ return fb;} };
  const writeJSON=(k,v)=>localStorage.setItem(k, JSON.stringify(v));
  const getCacheMap=()=>readJSON(LS_CACHE,{});
  const setCacheMap=(m)=>writeJSON(LS_CACHE,m);
  function touchMRU(n){ const a=readJSON(LS_MRU,[]); const i=a.indexOf(n); if(i!==-1)a.splice(i,1); a.unshift(n); writeJSON(LS_MRU,a.slice(0,50)); }
  function saveToCache(n,d){ const m=getCacheMap(); m[String(n)]={data:d,ts:now()}; setCacheMap(m); touchMRU(String(n)); }
  function getFromCache(n){ const m=getCacheMap(); const r=m[String(n)]; if(!r) return null; if(now()-(r.ts||0)>CACHE_TTL_MS) return null; return r.data; }
  async function revalidateKeys(keys){ for(const n of keys){ try{ const f=await netLookup(n,{bust:true}); if(f) saveToCache(n,f);}catch{} } }
  function warmupCacheOnLoad(){ const mru=readJSON(LS_MRU,[]).slice(0,10); if(mru.length) revalidateKeys(mru); }
  function startAutoRefresh(){ setInterval(()=>{ const mru=readJSON(LS_MRU,[]).slice(0,10); if(mru.length) revalidateKeys(mru);
    const m=getCacheMap(); let ch=false; for(const k of Object.keys(m)){ if(now()-(m[k].ts||0) > 2*CACHE_TTL_MS){ delete m[k]; ch=true; } } if(ch) setCacheMap(m);
  }, CACHE_TTL_MS); }

  // ===== Utils =====
  function withParams(base, params){ const u=new URL(base); Object.entries(params).forEach(([k,v])=>(v!==undefined&&v!==null)&&u.searchParams.set(k,v)); return u.toString(); }
  const normStr=(v)=> (v==null?'':String(v)).trim();
  function setStatusLoading(msg='Buscando‚Ä¶'){ status.innerHTML='<span class="spinner"></span>'+msg; }
  function clearStatus(){ status.textContent=''; }

  function pick(obj, keys){ for(const k of keys){ if(obj && obj[k]!=null && String(obj[k]).trim()!=='') return String(obj[k]); } return ''; }
  function pickNum(obj, keys){ const s=pick(obj,keys); if(!s) return 0; const n=Number(String(s).replace(/\./g,'').replace(',', '.').replace(/[^0-9\.\-]/g,'')); return isFinite(n)?n:0; }
  const fmt=(n)=> new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',minimumFractionDigits:2}).format(Number(n||0));

  // ===== Totales =====
  function computeMontos(item){
    const armazon=pickNum(item,['armazonPrecio','precioArmazon','precio_armazon','precio_armaz√≥n','armazon_precio','precioPublicoArmazon']);
    const cristal=pickNum(item,['cristalPrecio','precioCristal','precio_cristal','precioCristales']);
    const otros=pickNum(item,['otros','otroConcepto','otrosConceptos','adicional','extra','otro_monto']);
    const obra=pickNum(item,['obraSocial','obra_social','montoObraSocial','descuentoObraSocial']);
    const totalVista=pickNum(item,['total','total_pesos','importeTotal','totalCliente']);
    const senia=pickNum(item,['se√±a','senia','se√±a_monto','seniaMonto']);
    const pagosPrev=pickNum(item,['pagado','pagos','pagosPrevios','totalPagos','pago_acumulado']);
    const total= totalVista>0 ? totalVista : (armazon+cristal+otros-obra);
    let saldo = total - senia - pagosPrev; if (saldo<0) saldo=0;
    return { armazon, cristal, otros, obra, total, senia, pagosPrev, saldo };
  }
  function renderMontos(item){
    const m=computeMontos(item);
    mArmazon.textContent=fmt(m.armazon); mCristal.textContent=fmt(m.cristal); mOtros.textContent=fmt(m.otros);
    mObra.textContent=fmt(-Math.abs(m.obra)||0); mTotal.textContent=fmt(m.total); mSenia.textContent=fmt(m.senia);
    mPagos.textContent=fmt(m.pagosPrev); mSaldo.textContent=fmt(m.saldo);
    cancelo.value = m.saldo>0 ? m.saldo.toFixed(2) : '';
    btnEntregar.disabled = (m.saldo>0);
  }

  // ===== Historial de pagos =====
  async function fetchPagos(numero){
    const url = withParams(SCRIPT_URL,{ action:'pagos', numero, _:Date.now() });
    const res = await fetch(url, {cache:'no-store'});
    if (!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json(); // se espera: {ok:true, items:[{fecha, fdm, fdmOtro, importe, vendedor}]}
    if (Array.isArray(data)) return data; // fallback raro
    return data.items || [];
  }
  function renderPagos(list){
    tablaPagos.innerHTML='';
    list.forEach(p=>{
      const tr=document.createElement('tr');
      const medio = p.fdm === 'OTRO' && p.fdmOtro ? `OTRO (${p.fdmOtro})` : (p.fdm||'');
      tr.innerHTML = `
        <td>${normStr(p.fecha||p.fh||p.fechaHora||'')}</td>
        <td>${medio}</td>
        <td>${fmt(p.importe || p.monto || p.pago_importe || 0)}</td>
        <td>${normStr(p.vendedor || p.entregadoPor || p.usuario || '')}</td>`;
      tablaPagos.appendChild(tr);
    });
  }

  // ===== UI lista / selecci√≥n =====
  function renderLista(items){
    listaTable.innerHTML=''; const thead=document.createElement('thead');
    thead.innerHTML=`<tr><th>N¬∞</th><th>Paciente</th><th>DNI</th><th>Tel.</th><th>Estado</th><th>Retira</th></tr>`;
    const tbody=document.createElement('tbody');
    items.forEach(it=>{
      const tr=document.createElement('tr'); tr.tabIndex=0;
      tr.innerHTML=`
        <td class="num">${normStr(it.numero||it.nro||it.num)}</td>
        <td>${normStr(it.nombre||it.paciente)}</td>
        <td>${normStr(it.dni)}</td>
        <td>${normStr(it.telefono||it.tel)}</td>
        <td>${normStr(it.estado)?`<span class="badge">${it.estado}</span>`:''}</td>
        <td>${normStr(it.retira||it.fechaRetira||it.retiro)}</td>`;
      tr.addEventListener('click',()=>chooseItem(it));
      tr.addEventListener('keydown',(ev)=>{ if(ev.key==='Enter') chooseItem(it); });
      tbody.appendChild(tr);
    });
    listaTable.appendChild(thead); listaTable.appendChild(tbody); listaWrap.classList.remove('hidden');
  }
  function hideLista(){ listaWrap.classList.add('hidden'); listaTable.innerHTML=''; }

  function renderEntregaInfo(item){
    entregaInfo.textContent=''; entregaInfo.classList.add('hidden'); if(!item) return;
    const fecha=pick(item,['entregadoEl','fechaEntrega','entregadoFecha','fechaHora','fecha_y_hora','fecha_entrega','fh','fecha']);
    const quien=pick(item,['entregadoPor','entrego','vendedorEntrega','entregado_por','entrega_por']);
    const medio=pick(item,['fdm','medioPago','formaDePago','pagoMedio','medio_pago']);
    const otro =pick(item,['fdmOtro','medioPagoOtro','otro','pago_otro']);
    const monto=pick(item,['cancelo','monto','importe','pagado','pago_importe']);
    if (fecha||quien||medio||monto){
      const medioTxt=(medio==='OTRO'&&otro)?`OTRO (${otro})`:(medio||'');
      const partes=[]; if(fecha)partes.push(`Entregado el ${fecha}`); if(quien)partes.push(`por ${quien}`);
      if(medioTxt)partes.push(`‚Ä¢ FDM: ${medioTxt}`); if(monto)partes.push(`‚Ä¢ Importe: ${monto}`);
      entregaInfo.textContent=partes.join(' '); entregaInfo.classList.remove('hidden');
    }
  }

  let currentNumero=null, currentRawItem=null;

  function resetFormFields(){
    entregadoPor.value=''; fdm.value=''; fdmOtro.value=''; fdmOtroWrap.classList.add('hidden');
  }

  async function chooseItem(item){
    const numero=item.numero||item.nro||item.num;
    currentNumero=numero; currentRawItem=item;
    paciente.textContent=normStr(item.nombre||item.paciente)||'(sin nombre)';
    status.textContent=`Elegido N¬∞ ${numero}`;
    hideLista(); resultado.classList.remove('hidden'); resetFormFields();
    renderMontos(item); renderEntregaInfo(item); entregadoPor.focus();
    if (numero) saveToCache(String(numero), item);
    // cargar historial de pagos
    try{ const pagos=await fetchPagos(numero); renderPagos(pagos); }
    catch(_e){ renderPagos([]); }
  }

  // ===== Net lookups =====
  async function netLookup(numero,{bust=false}={}){
    const url=withParams(SCRIPT_URL,{action:'lookup',numero, ...(bust?{_:Date.now()}: {})});
    const res=await fetch(url,{method:'GET',cache:'no-store'});
    if(!res.ok) throw new Error('Error de red');
    const data=await res.json();
    if(Array.isArray(data)) return data;
    if(data.ok===false) throw new Error(data.error||'No encontrado');
    if(Array.isArray(data.items||data.results)) return (data.items||data.results);
    return data;
  }

  async function lookup(numero){
    setStatusLoading(); hideLista(); resultado.classList.add('hidden'); entregaInfo.classList.add('hidden');
    saveMsg.classList.add('hidden'); saveErr.classList.add('hidden');
    currentNumero=null; currentRawItem=null;

    const cached=getFromCache(numero);
    if(cached){
      clearStatus();
      if(Array.isArray(cached)){ cached.length===1?chooseItem(cached[0]):(status.textContent=`Se encontraron ${cached.length} coincidencias (cach√©)`, renderLista(cached)); }
      else chooseItem(cached);
      netLookup(numero,{bust:true}).then(d=>{ if(d) saveToCache(String(numero),d); }).catch(()=>{});
      return;
    }

    try{
      const data=await netLookup(numero); clearStatus(); saveToCache(String(numero),data);
      if(Array.isArray(data)){ data.length===1?chooseItem(data[0]):(status.textContent=`Se encontraron ${data.length} coincidencias`, renderLista(data)); }
      else chooseItem(data);
    }catch(e){
      clearStatus(); resultado.classList.add('hidden'); hideLista(); alert(e.message||'Error buscando');
    }
  }

  // ===== Registrar pago parcial =====
  async function addPago(){
    saveMsg.classList.add('hidden'); saveErr.classList.add('hidden');
    const vendedor=normStr(entregadoPor.value), importe=normStr(cancelo.value), medio=normStr(fdm.value), medioOtro=normStr(fdmOtro.value);
    if(!currentNumero){ saveErr.textContent='Primero busc√° y eleg√≠ un n√∫mero v√°lido.'; saveErr.classList.remove('hidden'); return; }
    if(!vendedor){ saveErr.textContent='Complet√° "Vendedor/a".'; saveErr.classList.remove('hidden'); entregadoPor.focus(); return; }
    if(!importe || Number(importe)<=0){ saveErr.textContent='Ingres√° un importe v√°lido.'; saveErr.classList.remove('hidden'); cancelo.focus(); return; }
    if(!medio){ saveErr.textContent='Eleg√≠ el medio de pago.'; saveErr.classList.remove('hidden'); fdm.focus(); return; }
    if(medio==='OTRO' && !medioOtro){ saveErr.textContent='Especific√° el medio de pago en "OTRO".'; saveErr.classList.remove('hidden'); fdmOtro.focus(); return; }

    btnAgregarPago.disabled=true; btnAgregarPago.textContent='Guardando‚Ä¶';
    try{
      // nuevo endpoint
      const url=withParams(SCRIPT_URL,{ action:'addPago', numero:currentNumero, importe, fdm:medio, fdmOtro:medioOtro, vendedor });
      const res=await fetch(url,{method:'GET',cache:'no-store'});
      if(!res.ok) throw new Error('Error de red');
      const data=await res.json();
      if(data.ok===false) throw new Error(data.error || 'No se pudo guardar el pago');

      // refrescar pagos e importes
      try{ const pagos=await fetchPagos(currentNumero); renderPagos(pagos); }catch(_e){}
      // actualizar montos locales
      const prevPagos = pickNum(currentRawItem||{}, ['pagado','pagos','pagosPrevios','totalPagos','pago_acumulado']);
      const nuevoAcumulado = data.totalPagos != null ? Number(data.totalPagos) : (prevPagos + Number(importe||0));
      currentRawItem = { ...(currentRawItem||{}), pagado: nuevoAcumulado };
      renderMontos(currentRawItem);

      saveMsg.textContent='‚úî Pago registrado'; saveMsg.classList.remove('hidden');
      cancelo.value=''; // limpio el importe
    }catch(e){
      saveErr.textContent = e.message || 'Error guardando pago'; saveErr.classList.remove('hidden');
    }finally{
      btnAgregarPago.textContent='Registrar pago'; btnAgregarPago.disabled=false;
    }
  }

  // ===== Marcar como ENTREGADO (solo si saldo=0) =====
  async function marcarEntregado(){
    saveMsg.classList.add('hidden'); saveErr.classList.add('hidden');
    const vendedor=normStr(entregadoPor.value)||'(sin nombre)';
    const saldoTxt = mSaldo.textContent || '$0';
    const saldoNum = Number(String(saldoTxt).replace(/\./g,'').replace(',', '.').replace(/[^0-9\.\-]/g,''));
    if (saldoNum>0){ saveErr.textContent='A√∫n hay saldo pendiente. No se puede marcar como entregado.'; saveErr.classList.remove('hidden'); return; }

    btnEntregar.disabled=true; btnEntregar.textContent='Marcando‚Ä¶';
    try{
      const url=withParams(SCRIPT_URL,{ action:'entregar', numero:currentNumero, entregadoPor:vendedor });
      const res=await fetch(url,{method:'GET',cache:'no-store'});
      if(!res.ok) throw new Error('Error de red');
      const data=await res.json();
      if(data.ok===false) throw new Error(data.error || 'No se pudo marcar como entregado');

      // mostrar cartel y l√≠nea informativa
      saveMsg.textContent='‚úî Marcado como ENTREGADO'; saveMsg.classList.remove('hidden');
      const fecha = pick(data, ['fecha','fechaEntrega','entregadoEl','fh','fechaHora']) || '';
      currentRawItem = { ...(currentRawItem||{}), entregadoPor:vendedor, entregadoEl:fecha };
      renderEntregaInfo(currentRawItem);
    }catch(e){
      saveErr.textContent = e.message || 'Error al marcar como entregado'; saveErr.classList.remove('hidden');
      btnEntregar.disabled=false;
    }finally{
      btnEntregar.textContent='Marcar como ENTREGADO';
    }
  }

  // ===== Eventos =====
  numeroInput.addEventListener('keydown',(ev)=>{ if(ev.key==='Enter'){ const v=normStr(numeroInput.value); if(v) lookup(v); } });
  fdm.addEventListener('change',()=>{ const isOtro=fdm.value==='OTRO'; fdmOtroWrap.classList.toggle('hidden',!isOtro); if(!isOtro) fdmOtro.value=''; });
  btnAgregarPago.addEventListener('click', addPago);
  btnEntregar.addEventListener('click', marcarEntregado);

  // Esc√°ner nativo
  let mediaStream=null, detector=null, rafId=0;
  const supportsBarcodeDetector=()=> 'BarcodeDetector' in window;
  async function openScanner(){
    scanModal.classList.add('open');
    try{
      mediaStream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:false });
      scanVideo.srcObject = mediaStream; await scanVideo.play();
      if (supportsBarcodeDetector()){
        detector=new BarcodeDetector({ formats:['code_128','ean_13','ean_8','upc_a','upc_e','code_39','qr_code'] });
        const tick=async()=>{ try{
          const codes=await detector.detect(scanVideo);
          if(codes && codes.length){ const code=(codes[0].rawValue||'').trim();
            if(code){ closeScanner(); numeroInput.value=code.replace(/[^\d]/g,'')||code; if(numeroInput.value.trim()) lookup(numeroInput.value.trim()); return; } }
        }catch(e){} rafId=requestAnimationFrame(tick); };
        rafId=requestAnimationFrame(tick);
      } else { scanHint.textContent='Tu navegador no soporta escaneo directo.'; }
    }catch(e){ alert('No se pudo acceder a la c√°mara.'); closeScanner(); }
  }
  function stopScanner(){ if(rafId) cancelAnimationFrame(rafId); rafId=0; if(mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; } }
  function closeScanner(){ stopScanner(); scanModal.classList.remove('open'); }
  $('btnScan').addEventListener('click', openScanner);
  $('scanClose').addEventListener('click', closeScanner);
  document.addEventListener('click',(e)=>{ if(!scanModal.classList.contains('open')) return; if(e.target===scanModal){ closeScanner(); } });

  // Init
  document.addEventListener('DOMContentLoaded', ()=>{
    numeroInput.focus();
    warmupCacheOnLoad(); startAutoRefresh();
  });
</script>
</body>
</html>

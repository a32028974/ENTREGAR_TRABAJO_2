<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Entrega ‚Ä¢ √ìptica Cristal</title>
<link rel="icon" href="logo.png" />
<style>
  :root { --bg:#e5f7b7; --card:#121a2b; --text:#e8eefc; --muted:#9fb0d6; --accent:#7cc0ff; }
  *{box-sizing:border-box}
  body{margin:0; font:16px/1.4 system-ui,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text);}
  .wrap{max-width:520px;margin:24px auto;padding:16px}
  .card{background:var(--card);border:1px solid #1e2a42;border-radius:14px;padding:16px;box-shadow:0 6px 22px rgba(0,0,0,.25)}
  h1{margin:0 0 12px 0;font-size:20px}
  label{display:block;font-size:13px;color:var(--muted);margin:12px 0 6px}
  input,select,button{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #2a3b5f;background:#0e1626;color:var(--text)}
  input::placeholder{color:#6e82ad}
  button{background:var(--accent); color:#05223a; font-weight:700; border:none; cursor:pointer}
  button:disabled{opacity:.6;cursor:not-allowed}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .ok{color:#8fffb3;margin-top:8px}
  .err{color:#ff9c9c;margin-top:8px}
  .muted{color:var(--muted)}
  .hidden{display:none}
  .pill{display:inline-block;background:#0f223a;border:1px solid #294a78;color:#b8d5ff;border-radius:999px;padding:6px 10px;margin-top:6px}
  .hr{height:1px;background:#203152;margin:14px 0}

  /* === Lista de coincidencias === */
  .table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 14px;
           background:#0e1626; border:1px solid #2a3b5f; border-radius: 10px; overflow: hidden; }
  .table th, .table td { padding: 8px 10px; border-bottom: 1px solid #22324f; text-align: left; white-space: nowrap; }
  .table tr:last-child td { border-bottom: 0; }
  .table th { color:#b8d5ff; font-weight:600; background:#0f1a2c; }
  .table tr { cursor: pointer; }
  .table tr:hover { background:#0f223a; }
  .table .num { font-weight:700; color:#9fd1ff; }
  .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px;
           border:1px solid #294a78; color:#b8d5ff; background:#0f223a; }

  /* Spinner ‚ÄúBuscando‚Ä¶‚Äù */
  .spinner { display:inline-block; width:14px; height:14px; border:2px solid #6e82ad; border-top-color:transparent; border-radius:50%; vertical-align:-2px; animation:spin 1s linear infinite; margin-right:6px; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Accesibilidad foco tabla */
  .table tr:focus { outline:2px solid #7cc0ff; outline-offset:-2px; }

  /* ======== INPUT + SCAN BUTTON ======== */
  .input-row { display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:end; }
  .scanBtn, .button { padding:12px 14px; border-radius:10px; border:1px solid #2a3b5f; background:#113052; color:#b8d5ff; font-weight:700; text-decoration:none; text-align:center; }
  .scanBtn:hover, .button:hover { background:#14365d; }

  /* ======== MODAL ESC√ÅNER (estilo del otro c√≥digo) ======== */
  .scan-modal { position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; place-items:center; padding:16px; z-index:9999; }
  .scan-modal.open { display:grid; }
  .scan-box { width:min(520px,96vw); background:var(--card); border:1px solid #1e2a42; border-radius:14px; padding:12px; box-shadow: 0 12px 32px rgba(0,0,0,.45); }
  .scan-head { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px; }
  .scan-close { padding:10px 12px; border-radius:10px; border:1px solid #2a3b5f; background:#0e1626; color:var(--text); cursor:pointer; }
  .scan-video { width:100%; border-radius:12px; border:1px solid #22324f; background:#000; display:block; }
  .scan-hint { margin-top:8px; font-size:12px; color:#9fb0d6; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Registrar entrega / pago de saldo</h1>

      <label for="numero">N√∫mero de trabajo</label>
      <div class="input-row">
        <input id="numero" type="text" inputmode="numeric" placeholder="Escrib√≠ el n√∫mero y presion√° Enter" autocomplete="off" />
        <button id="btnScan" class="scanBtn" type="button">üì∑ Escanear</button>
      </div>
      <div style="margin-top:8px; display:flex; gap:8px;">
        <a id="btnScanApp" class="button" href="#">Abrir app de escaneo</a>
      </div>

      <div id="status" class="muted" aria-live="polite"></div>

      <!-- Lista de coincidencias m√∫ltiples -->
      <div id="listaWrap" class="hidden">
        <div class="hr"></div>
        <div class="muted">Coincidencias encontradas (eleg√≠ una)</div>
        <div class="tableWrap" style="overflow:auto; max-height:260px; border-radius:10px; margin-top:6px;">
          <table class="table" id="lista"></table>
        </div>
      </div>

      <div id="resultado" class="hidden">
        <div class="hr"></div>
        <div class="muted">Paciente</div>
        <div id="paciente" class="pill"></div>

        <!-- Info si YA fue entregado/pagado antes -->
        <div id="entregaInfo" class="muted" style="margin-top:8px;"></div>

        <div class="hr"></div>

        <label for="entregadoPor">¬øQui√©n entreg√≥?</label>
        <input id="entregadoPor" type="text" placeholder="Nombre del vendedor/a que entreg√≥" autocomplete="off" />

        <div class="row">
          <div>
            <label for="cancelo">¬øCu√°nto pag√≥?</label>
            <input id="cancelo" type="number" step="0.01" placeholder="0.00" inputmode="decimal" />
          </div>
          <div>
            <label for="fdm">¬øC√≥mo pag√≥?</label>
            <select id="fdm">
              <option value="">Eleg√≠ una opci√≥n‚Ä¶</option>
              <option>EFECTIVO</option>
              <option>TARJETA 1P</option>
              <option>TARJETA 3P</option>
              <option>TARJETA 6P</option>
              <option>TARJETA 12P</option>
              <option>TRANSFERENCIA</option>
              <option>MERCADO PAGO</option>
              <option>OTRO</option>
            </select>
          </div>
        </div>

        <!-- Campo libre SOLO si elige OTRO -->
        <div id="wrapFdmOtro" class="hidden">
          <label for="fdmOtro">Especific√° el medio de pago</label>
          <input id="fdmOtro" type="text" placeholder="Ej: CHEQUE, VALE, PROMO X, etc." autocomplete="off" />
        </div>

        <div class="hr"></div>
        <button id="guardarBtn" disabled>Guardar</button>
        <div id="saveMsg" class="ok hidden">‚úî Guardado</div>
        <div id="saveErr" class="err hidden"></div>
      </div>
    </div>
  </div>

  <!-- ==== MODAL ESCANEO (como el otro c√≥digo) ==== -->
  <div id="scanModal" class="scan-modal">
    <div id="scanBox" class="scan-box">
      <div class="scan-head">
        <h3>Escanear c√≥digo de barras</h3>
        <button id="scanClose" class="scan-close" type="button">Cerrar</button>
      </div>
      <video id="scanVideo" class="scan-video" playsinline muted></video>
      <div id="scanHint" class="scan-hint">Apunt√° al c√≥digo hasta que se detecte autom√°ticamente.</div>
    </div>
  </div>

<script>
  // === TU URL DE APP SCRIPT ===
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx2oao4ZVckDweyVZJ1u9rlH72xS4d8UEIR72qxG5fQOuSM4ooLWL9a17lTVD93AzloaQ/exec';

  // ======== UTIL DOM ========
  const $ = (id)=>document.getElementById(id);
  const numeroInput = $('numero');
  const status = $('status');
  const listaWrap = $('listaWrap');
  const listaTable = $('lista');
  const resultado = $('resultado');
  const paciente = $('paciente');
  const entregaInfo = $('entregaInfo');
  const entregadoPor = $('entregadoPor');
  const cancelo = $('cancelo');
  const fdm = $('fdm');
  const fdmOtroWrap = $('wrapFdmOtro');
  const fdmOtro = $('fdmOtro');
  const guardarBtn = $('guardarBtn');
  const saveMsg = $('saveMsg');
  const saveErr = $('saveErr');

  // === Esc√°ner (IDs iguales al otro c√≥digo)
  const btnScan = $('btnScan');
  const scanModal = $('scanModal');
  const scanBox = $('scanBox');
  const scanVideo = $('scanVideo');
  const scanClose = $('scanClose');
  const btnScanApp = $('btnScanApp');
  const scanHint = $('scanHint');

  // ======== CACHE (localStorage) ========
  // Claves
  const LS_CACHE = 'oc_entrega_cache_v1';    // { numero: {data, ts} }
  const LS_MRU   = 'oc_entrega_mru_v1';      // [num1,num2,...] √∫ltimos consultados
  const CACHE_TTL_MS = 15 * 60 * 1000;       // 15 minutos

  // Helpers cache
  function now(){ return Date.now(); }
  function readJSON(key, fallback){
    try{ const s = localStorage.getItem(key); return s ? JSON.parse(s) : fallback; }catch{ return fallback; }
  }
  function writeJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

  function getCacheMap(){ return readJSON(LS_CACHE, {}); }
  function setCacheMap(map){ writeJSON(LS_CACHE, map); }

  function touchMRU(numero){
    const mru = readJSON(LS_MRU, []);
    const idx = mru.indexOf(numero);
    if (idx !== -1) mru.splice(idx,1);
    mru.unshift(numero);
    // Limitar a 50 √∫ltimos
    writeJSON(LS_MRU, mru.slice(0,50));
  }

  function saveToCache(numero, data){
    const map = getCacheMap();
    map[String(numero)] = { data, ts: now() };
    setCacheMap(map);
    touchMRU(String(numero));
  }

  function getFromCache(numero){
    const map = getCacheMap();
    const rec = map[String(numero)];
    if (!rec) return null;
    if (now() - (rec.ts || 0) > CACHE_TTL_MS) return null; // vencido
    return rec.data;
  }

  async function revalidateKeys(keys){
    // revalida (refetch) en segundo plano todas las claves indicadas
    for (const numero of keys){
      try{
        const fresh = await netLookup(numero, { bust: true });
        if (fresh) saveToCache(numero, fresh);
      }catch(_e){}
    }
  }

  async function warmupCacheOnLoad(){
    // 1) Si vuelve con ?numero en URL, lo tomar√° lookup normal.
    // 2) Tomar MRU y revalidar silenciosamente al abrir.
    const mru = readJSON(LS_MRU, []).slice(0,10); // top 10 m√°s usados
    if (mru.length) revalidateKeys(mru);
  }

  function startAutoRefresh(){
    // Cada 15 min revalida top 10 MRU
    setInterval(()=>{
      const mru = readJSON(LS_MRU, []).slice(0,10);
      if (mru.length) revalidateKeys(mru);
      // limpiar entradas muy viejas (2√ó TTL)
      const map = getCacheMap();
      let changed = false;
      for (const k of Object.keys(map)){
        if (now() - (map[k].ts || 0) > (2*CACHE_TTL_MS)){ delete map[k]; changed = true; }
      }
      if (changed) setCacheMap(map);
    }, CACHE_TTL_MS);
  }

  // ======== NETWORK LAYER ========
  function withParams(base, params){
    const u = new URL(base);
    Object.entries(params).forEach(([k,v]) => (v!==undefined && v!==null) && u.searchParams.set(k, v));
    return u.toString();
  }
  const normStr = (v)=> (v==null ? '' : String(v)).trim();

  async function netLookup(numero, { bust=false } = {}){
    const url = withParams(SCRIPT_URL, { action:'lookup', numero, ...(bust ? { _: String(Date.now()) } : {}) });
    const res = await fetch(url, { method:'GET', cache: 'no-store' });
    if (!res.ok) throw new Error('Error de red');
    const data = await res.json();
    // Normalizamos: devolver { items:[...] } o un √∫nico objeto
    if (Array.isArray(data)) return data;
    if (data.ok === false) throw new Error(data.error || 'No encontrado');
    if (Array.isArray(data.items || data.results)) return (data.items || data.results);
    return data; // objeto √∫nico
  }

  function setStatusLoading(msg='Buscando‚Ä¶'){
    status.innerHTML = '<span class="spinner" aria-hidden="true"></span>' + msg;
  }
  function clearStatus(){ status.textContent = ''; }

  function pick(obj, keys){
    for (const k of keys){
      if (obj && obj[k] != null && String(obj[k]).toString().trim() !== '') return String(obj[k]);
    }
    return '';
  }

  function renderEntregaInfo(item){
    entregaInfo.textContent = '';
    entregaInfo.classList.add('hidden');
    if (!item) return;

    const fecha = pick(item, ['entregadoEl','fechaEntrega','entregadoFecha','fechaHora','fecha_y_hora','fecha_entrega','fh','fecha']);
    const quien = pick(item, ['entregadoPor','entrego','vendedorEntrega','entregado_por','entrega_por']);
    const medio = pick(item, ['fdm','medioPago','formaDePago','pagoMedio','medio_pago']);
    const otro  = pick(item, ['fdmOtro','medioPagoOtro','otro','pago_otro']);
    const monto = pick(item, ['cancelo','monto','importe','pagado','pago_importe']);

    if (fecha || quien || medio || monto){
      const medioTxt = (medio === 'OTRO' && otro) ? `OTRO (${otro})` : (medio || '');
      const partes = [];
      if (fecha) partes.push(`Entregado el ${fecha}`);
      if (quien) partes.push(`por ${quien}`);
      if (medioTxt) partes.push(`‚Ä¢ FDM: ${medioTxt}`);
      if (monto) partes.push(`‚Ä¢ Importe: ${monto}`);
      entregaInfo.textContent = partes.join(' ');
      entregaInfo.classList.remove('hidden');
    }
  }

  function renderLista(items){
    listaTable.innerHTML = '';
    const thead = document.createElement('thead');
    thead.innerHTML = `
      <tr>
        <th>N¬∞</th>
        <th>Paciente</th>
        <th>DNI</th>
        <th>Tel.</th>
        <th>Estado</th>
        <th>Retira</th>
      </tr>`;
    const tbody = document.createElement('tbody');

    items.forEach(it=>{
      const tr = document.createElement('tr');
      tr.tabIndex = 0;
      tr.innerHTML = `
        <td class="num">${normStr(it.numero || it.nro || it.num)}</td>
        <td>${normStr(it.nombre || it.paciente)}</td>
        <td>${normStr(it.dni)}</td>
        <td>${normStr(it.telefono || it.tel)}</td>
        <td>${normStr(it.estado) ? `<span class="badge">${it.estado}</span>`:''}</td>
        <td>${normStr(it.retira || it.fechaRetira || it.retiro)}</td>
      `;
      tr.addEventListener('click', ()=> chooseItem(it));
      tr.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter') chooseItem(it); });
      tbody.appendChild(tr);
    });

    listaTable.appendChild(thead);
    listaTable.appendChild(tbody);
    listaWrap.classList.remove('hidden');
  }
  function hideLista(){
    listaWrap.classList.add('hidden');
    listaTable.innerHTML = '';
  }

  function resetFormFields(){
    entregadoPor.value = '';
    cancelo.value = '';
    fdm.value = '';
    fdmOtro.value = '';
    fdmOtroWrap.classList.add('hidden');
  }

  let currentNumero = null;
  let currentRawItem = null;

  function chooseItem(item){
    const numero = item.numero || item.nro || item.num;
    currentNumero = numero;
    currentRawItem = item;
    paciente.textContent = normStr(item.nombre || item.paciente) || '(sin nombre)';
    status.textContent  = `Elegido N¬∞ ${numero}`;
    hideLista();
    resultado.classList.remove('hidden');
    guardarBtn.disabled = false;
    resetFormFields();
    renderEntregaInfo(item);
    entregadoPor.focus();
    // Guardar en cache este item puntual
    if (numero) saveToCache(String(numero), item);
  }

  async function lookup(numero){
    setStatusLoading();
    hideLista();
    resultado.classList.add('hidden');
    entregaInfo.classList.add('hidden');
    saveMsg.classList.add('hidden');
    saveErr.classList.add('hidden');
    guardarBtn.disabled = true;
    currentNumero = null;
    currentRawItem = null;

    // 1) cache primero
    const cached = getFromCache(numero);
    if (cached){
      clearStatus();
      // Puede ser 1 objeto o lista cacheada
      if (Array.isArray(cached)){
        if (cached.length === 1) chooseItem(cached[0]);
        else { status.textContent = `Se encontraron ${cached.length} coincidencias (cach√©)`; renderLista(cached); }
      } else {
        chooseItem(cached);
      }
      // Revalidar en segundo plano
      netLookup(numero, { bust:true }).then(data=>{
        if (!data) return;
        saveToCache(String(numero), data);
      }).catch(()=>{});
      return;
    }

    // 2) red
    try{
      const data = await netLookup(numero);
      clearStatus();
      // guardar cache
      saveToCache(String(numero), data);

      if (Array.isArray(data)){
        if (data.length === 0) throw new Error('No encontrado');
        if (data.length === 1) { chooseItem(data[0]); }
        else {
          status.textContent = `Se encontraron ${data.length} coincidencias`;
          renderLista(data);
        }
      } else {
        chooseItem(data);
      }
    }catch(e){
      clearStatus();
      resultado.classList.add('hidden');
      hideLista();
      alert(e.message || 'Error buscando');
    }
  }

  // ========= SAVE =========
  async function save(){
    saveMsg.classList.add('hidden');
    saveErr.classList.add('hidden');

    const ep  = normStr(entregadoPor.value);
    const aj  = normStr(cancelo.value);
    const ak  = normStr(fdm.value);
    const akOtro = normStr(fdmOtro.value);

    if (!currentNumero){
      saveErr.textContent = 'Primero busc√° y eleg√≠ un n√∫mero v√°lido.';
      saveErr.classList.remove('hidden');
      return;
    }
    if (!ep){
      saveErr.textContent = 'Complet√° "Qui√©n entreg√≥".';
      saveErr.classList.remove('hidden');
      entregadoPor.focus();
      return;
    }
    if (!ak){
      saveErr.textContent = 'Eleg√≠ el medio de pago.';
      saveErr.classList.remove('hidden');
      fdm.focus();
      return;
    }
    if (ak === 'OTRO' && !akOtro){
      saveErr.textContent = 'Especific√° el medio de pago en "OTRO".';
      saveErr.classList.remove('hidden');
      fdmOtro.focus();
      return;
    }

    guardarBtn.disabled = true;
    const oldTxt = guardarBtn.textContent;
    guardarBtn.textContent = 'Guardando‚Ä¶';

    try{
      const url = withParams(SCRIPT_URL, {
        action:'save',
        numero: currentNumero,
        entregadoPor: ep,
        cancelo: aj,
        fdm: ak,
        fdmOtro: akOtro
      });
      const res = await fetch(url, { method:'GET', cache:'no-store' });
      if (!res.ok) throw new Error('Error de red');
      const data = await res.json();

      if (data.ok === false){
        throw new Error(data.error || 'No se pudo guardar');
      }
      saveErr.classList.add('hidden');
      saveMsg.classList.remove('hidden');
      guardarBtn.textContent = oldTxt;
      guardarBtn.disabled = false;

      // Actualizo info mostrada y cache
      const updated = {
        ...(currentRawItem || {}),
        entregadoPor: ep,
        cancelo: aj,
        fdm: ak,
        fdmOtro: akOtro,
        entregadoEl: pick(data, ['fecha','fechaEntrega','entregadoEl','fh','fechaHora']) || pick(currentRawItem||{}, ['entregadoEl','fechaEntrega','fechaHora']) || ''
      };
      currentRawItem = updated;
      renderEntregaInfo(updated);
      // Persistir en cach√©
      saveToCache(String(currentNumero), updated);
    }catch(e){
      saveErr.textContent = e.message || 'Error guardando';
      saveErr.classList.remove('hidden');
      guardarBtn.textContent = oldTxt;
      guardarBtn.disabled = false;
    }
  }

  // ---- Eventos base ----
  numeroInput.addEventListener('keydown', (ev)=>{
    if (ev.key === 'Enter'){
      const val = normStr(numeroInput.value);
      if (val) lookup(val);
    }
  });
  $('guardarBtn').addEventListener('click', save);

  // Mostrar/ocultar campo ‚ÄúOTRO‚Äù
  fdm.addEventListener('change', ()=>{
    const isOtro = fdm.value === 'OTRO';
    fdmOtroWrap.classList.toggle('hidden', !isOtro);
    if (!isOtro) fdmOtro.value = '';
  });

  // ====================== ESC√ÅNER CON C√ÅMARA (id√©ntico estilo al otro) ======================
  let mediaStream = null;
  let detector = null;
  let rafId = 0;

  function supportsBarcodeDetector(){ return 'BarcodeDetector' in window; }

  async function openScanner(){
    scanModal.classList.add('open');
    const video = scanVideo;
    try{
      mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio:false });
      video.srcObject = mediaStream;
      await video.play();

      if (supportsBarcodeDetector()){
        detector = new BarcodeDetector({ formats: ['code_128','ean_13','ean_8','upc_a','upc_e','code_39','qr_code'] });
        const tick = async () => {
          try{
            const codes = await detector.detect(video);
            if (codes && codes.length){
              const code = (codes[0].rawValue || '').trim();
              if (code){
                closeScanner();
                numeroInput.value = code.replace(/[^\d]/g,'') || code;
                if (numeroInput.value.trim()) lookup(numeroInput.value.trim());
                return;
              }
            }
          }catch(e){ /* ignore frame errors */ }
          rafId = requestAnimationFrame(tick);
        };
        rafId = requestAnimationFrame(tick);
      } else {
        scanHint.textContent = 'Tu navegador no soporta escaneo directo. Us√° ‚ÄúAbrir app de escaneo‚Äù.';
      }
    }catch(e){
      alert('No se pudo acceder a la c√°mara.');
      closeScanner();
    }
  }

  function stopScanner(){
    if (rafId) cancelAnimationFrame(rafId);
    rafId = 0;
    if (mediaStream){
      mediaStream.getTracks().forEach(t=>t.stop());
      mediaStream = null;
    }
  }

  function closeScanner(){
    stopScanner();
    scanModal.classList.remove('open');
  }

  function buildZxingLink(){
    const here = new URL(window.location.href);
    const ret = new URL(here.href);
    ret.searchParams.set('via', 'scanapp');
    ret.searchParams.set('numero', '{CODE}');
    const params = new URLSearchParams({
      ret: ret.toString(),
      SCAN_FORMATS: 'CODE_128,EAN_13,EAN_8,UPC_A,UPC_E,QR_CODE'
    });
    return `zxing://scan/?${params.toString()}`;
  }

  function applyQueryPrefill(){
    const q = new URLSearchParams(window.location.search);
    const nro = q.get('numero') || q.get('nro');
    if (nro){
      numeroInput.value = nro.trim();
      lookup(nro.trim());
    }
  }

  // Eventos esc√°ner
  btnScan.addEventListener('click', openScanner);
  scanClose.addEventListener('click', closeScanner);
  document.addEventListener('click', (e)=>{
    if (!scanModal.classList.contains('open')) return;
    if (e.target === scanModal){ closeScanner(); }
  });

  // ====================== INIT ======================
  document.addEventListener('DOMContentLoaded', ()=>{
    // foco al abrir
    numeroInput.focus();

    // warmup de cache con MRU y auto-refresh cada 15'
    warmupCacheOnLoad();
    startAutoRefresh();

    // Link app externa de escaneo (ZXing)
    const zxing = buildZxingLink();
    btnScanApp.setAttribute('href', zxing);

    // Si volvemos con ?numero=...
    applyQueryPrefill();
  });
</script>
</body>
</html>
